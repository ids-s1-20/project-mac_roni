---
title: "Project proposal"
author: "macRoni"
output: github_document
---

```{r load-packages, message = FALSE}
library(tidyverse)
library(broom)
library(readr)
library(skimr)
library(tidytext)
```

## 1. Introduction
The dataset is a Skytrax User Reviews Dataset (published August 2nd, 2015) at https://github.com/quankiquanki/skytrax-reviews-dataset .  


General Theme: Which amenities impact the airline rating the most?

## 2. Data

```{r read-files, message = FALSE }
airline <- read_csv("/cloud/project/data/airline.csv")
airport <- read_csv("/cloud/project/data/airport.csv")
lounge <- read_csv("/cloud/project/data/lounge.csv")
seat <- read_csv("/cloud/project/data/seat.csv")
```

```{r}
glimpse(airline)
glimpse(airport)
glimpse(lounge)
glimpse(seat)
```

## 3. Data analysis plan

We first began by exploring the overall average ratings of the different airlines. 

```{r}
airline %>%
  group_by(airline_name) %>%
  summarise( average_overall_rating = mean(overall_rating, na.rm = TRUE)) %>%
  arrange(desc(average_overall_rating))

```

Next, we visualised the distribution of the traveller types the airline attracts.
Although, this visualization doesn't take into account the 31018 missing values. 

```{r}
airline %>%
  filter(type_traveller != "NA") %>%
  ggplot( mapping = aes( y = type_traveller)) +
  geom_bar() +
  labs( title = "Distribution of the traveller types", 
        y = "Traveller types" 
        ) +
  theme_minimal()
```


1. How does the overall ratings for airlines change depending of the time of year? Do these patterns repeat every year? Which traveller type is prev during which time of the year?


Which type of travelers in first class give better overall ratings than passengers in other classes? 
Does this alternate between different airlines?

First, all NAs for the response variable and the predictor were removed. 

```{r mean-ratings-airlines, message = FALSE}
airline_nonas <- airline %>%
  drop_na(overall_rating) #removing any NAs
```

Next, we want to investigate how time affects ratings. As the research question focuses on how airlines get high ratings, the five airlines with the highest rating were found. A limit of at least 100 survey submissions was imposed to increase the number of data points.

```{r five-highest-rated-airlines, message = FALSE, echo = FALSE}
airline_nonas %>%
  group_by(airline_name) %>%
  summarise(mean_overall_rating = mean(overall_rating, na.rm = TRUE),
            n = n()) %>%
  filter(n >= 100) %>%
  arrange(desc(mean_overall_rating))
```

These airlines were plotted against time to identify any correlations.

```{r five-highest-ratings-plot, message = FALSE, echo = FALSE}
airline_nonas %>%
  group_by(airline_name, date) %>%
  summarise(mean_overall_rating = mean(overall_rating, na.rm = TRUE)) %>%
  filter(airline_name %in% c("asiana-airlines", "garuda-indonesia", "air-astana", "bangkok-airways", "indigo-airlines"),
         date >= "2014-01-01") %>%
  ggplot(aes(x = date, y = mean_overall_rating, color = airline_name)) +
  geom_smooth(se = FALSE) +
  labs(
    title = "Overall ratings of five highest ranked airlines",
    subtitle = "From 2014 to 2015",
    x = "Date",
    y = "Overall Rating"
  ) +
  guides(color = guide_legend(title = "Airline Name")) 
  
```

As the visualization shows, all of the airlines receive ratings in between 5-10, with air-astana showing an increase at the end of 2015. For indigo-airlines, garuda-indonesia and bangkok-airlines, the ratings deteriorated at the end of 2015. Garuda-indonesia ratings stay constant throughout both years.

There is no clear pattern in each year, which makes sense as the airline companies will normally try to provide the same service throughout the year. 


1.5. Which amenity significantly contributes to the top 5 airlines' overall rating?

One can look at the individual ratings (Seat Comfort, Cabin Staff, Food Beverages, Inflight Entertainment and Money Value) and see if there is one rating that sticks out depending on the airline. 

```{r all-airlines-ratings-breakdown, message = FALSE, echo = FALSE}
airline_nonas %>%
  group_by(airline_name, date) %>%
  summarise(mean_seat_comfort_rating = mean(seat_comfort_rating, na.rm = TRUE),
            mean_cabin_staff_rating = mean(cabin_staff_rating, na.rm = TRUE),
            mean_food_beverages_rating = mean(food_beverages_rating, na.rm = TRUE),
            mean_inflight_entertainment_rating = mean(inflight_entertainment_rating, na.rm = TRUE),
            mean_value_money_rating = mean(value_money_rating, na.rm = TRUE),
            ) %>%
  filter(airline_name %in% c("asiana-airlines", "garuda-indonesia", "air-astana", "bangkok-airways", "indigo-airlines"),
         date >= "2014-01-01") %>%
  ggplot(aes(x = date)) +
  geom_smooth(aes(y = mean_seat_comfort_rating, color = "red"), se = FALSE) +
  geom_smooth(aes(y = mean_cabin_staff_rating, color = "green"), se = FALSE) +
  geom_smooth(aes(y = mean_food_beverages_rating, color = "blue"), se = FALSE) +
  geom_smooth(aes(y = mean_inflight_entertainment_rating, color = "yellow"), se = FALSE) +
  geom_smooth(aes(y = mean_value_money_rating, color = "black"), se = FALSE) +
  labs(
    title = "Seat Comfort, Cabin Staff, Food Beverages, Inflight Entertainment and 
Money Value Ratings for Top Five Airlines",
    subtitle = "From 2014 to 2015",
    x = "Date",
    y = "Rating"
  ) +
  scale_color_identity(name = "Type of Rating (Mean)",
                          breaks = c("red", "green", "blue", "yellow", "black"),
                          labels = c("Seat Comfort", "Cabin Staff", "Food Beverages", "Inflight Entertainment", "Money Value"),
                          guide = "legend") +
  facet_wrap(~airline_name, ncol = 3)
  
```
As the visualisation shows, to increase in overall rating, all individaul ratings have to increase. This can be seen in the example of Air Astana. For airlines that decreased in overall rating (bangkok-airways and indigo-airlines), only specific individual ratings decreased or had an overall worse score (especially inflight entertainment). 



# Question 2 

2. To what extent do passengers in first class give better ratings than passengers in economy/Premium Economy, etc?
Also, how satisfied are the first class passengers with the services they mentioned in their comments the most about?  


Let's look at the average overall rating the passengers gave for each of the classes. 

```{r}
airline %>%
  filter(!is.na(overall_rating), !is.na(cabin_flown) ) %>%
  group_by(cabin_flown) %>%
  summarise(mean_overall_rating = mean(overall_rating, na.rm = TRUE)) %>%
  arrange(desc(mean_overall_rating))
```

Hypothesis: we expect first class to have a higher rating.

Business class has received the highest amount of rating. It is closely followed by 
First class. This doesn't match our hypothesis. 

Is this because passengers feel the business class services are better or fewer people choose
to travel in first class?
Let's find out!

```{r}
airline %>%
  filter(!is.na(overall_rating), !is.na(cabin_flown) ) %>%
  group_by(cabin_flown) %>%
  count(cabin_flown) %>%
  arrange(desc(n))
```

Now, it is obvious that first class has a lower rating compared to business 
class since fewer passengers chose that cabin type. 

Let's look into what type of travelers opt for first class cabin which may be able to explain the above. 


```{r}
airline %>%
  filter (!is.na(cabin_flown), !is.na(type_traveller), !is.na(overall_rating) ) %>%
  ggplot(aes(x = cabin_flown, fill = type_traveller)) +
  geom_bar(position ="fill") +
  coord_flip()

```

This reveals the type of travelers in each of the cabins.

For first class, as expected, the solo leisure traveller_type prevails. This adds up since
the tickets may cost significantly more than any of the other classes so it may 
not be pocket-friendly to travel in larger groups than 1.   
The distribution of travelers also reveals why first class has the smallest number of passengers since
'couple leisure' and 'family leisure' categories don't form a large section of first class cabin passengers.  

Let's look into which aspects of the services did the first class cabin passengers mention about in their comments and 
how did they rate them? 
 
Filtered for NAs for variables that I am entirely sure of looking into.

```{r}
airline_amen_nonas <- airline %>%
  drop_na(overall_rating, value_money_rating, cabin_flown)  

```

Text analysis:

```{r}

airline_amen_nonas %>%
  filter( cabin_flown == "First Class" ) %>%
  unnest_tokens(word, content) %>%
  anti_join(get_stopwords(), by = "word") %>%
  count(word, sort = TRUE) %>% 
  slice_max(n, n = 20)

```

The results reveal words like "wifi", "connectivity", "entertainment"  don't appear, so I will choose to not look 
into the amenity variable associated with those words as it is not ***highly*** reviewed by the first class passengers. The word 'service' does appear 4th in the list but the word ground is not there so it is not 
a strong enough indicator for me to choose the ground_service amenity. 
So, after narrowing my search, I will filter for seat, cabin staff and food and, explore the ratings given for these. 
The amen_filtered has been extended accordingly from airline_amen_nonas. 

```{r}

amen_filtered <- airline %>%
  drop_na(overall_rating, value_money_rating, cabin_flown, seat_comfort_rating,
          cabin_staff_rating, food_beverages_rating)  

```

```{r}
amen_filtered %>%
  filter( cabin_flown == "First Class" ) %>%
  select( cabin_flown, overall_rating, value_money_rating, seat_comfort_rating,
          cabin_staff_rating, food_beverages_rating) %>%
  summarise(mean_seat_comfort_rating = mean(seat_comfort_rating),
            mean_cabin_staff_rating = mean(cabin_staff_rating),
            mean_food_beverages_rating = mean(food_beverages_rating),
            mean_value_money_rating = mean(value_money_rating),
            mean_overall_rating = mean(overall_rating))
```

Perhaps, this can mean that the mention of these services in the comments made has been fairly positive according to
the mean results yielded. Also, seeing the mention of words like good, great, comfortable and excellent reinforces can aid the claim made above. 

This runs in line with the mean overall rating proportionately as they both are around 65%.  

# End of question 2



***unnecesary for Purvi's task, does anyone else find this useful to know?***

How the overall flight rating varies.

```{r}
airline %>%
  filter(!is.na(overall_rating)) %>%
  group_by(overall_rating) %>%
  count(overall_rating) 

airline %>% 
  filter(!is.na(overall_rating)) %>%
  group_by(overall_rating) %>%
  count(overall_rating) %>%
  ggplot(aes(x=factor(overall_rating), y = n)) + ## want to fill it by cabin_flown but running into errors 
  geom_col() 
```

Majority of the travelers have rated the airlines a 10 (5861 to be exact) but ratings 
like 8, 9, 10 are also common. Surprisingly, the extreme value of rating = 1 is also 
frequent. 


Do airlines improve their ratings with a particular reviewer over time, if so in which category are the improvements made
Y: overall_rating, other variables TBD after the most significant contributor is found 
X: author, date, airline_name 

Do positive reviews on an airline and positive reviews on lounge and seat have a correlation?
Y: a graph showing correlation 
X: overall_rating (in seat and lounge data set )

Hypothesis: we expect seat rating to have a stronger correlation than the lounge rating because not everyone uses the lounge. 
