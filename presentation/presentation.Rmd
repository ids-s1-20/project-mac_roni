---
title: "How do the amenities impact the flight's overall rating?"
subtitle: "By cabin, seat, lounge and over time"
author: "macaRoni <br> Sophie Kerfoot, Ben Thamm, Henrich Hegedus, Purvi Harwani"
institute: "University of Edinburgh"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      ratio: "16:9"
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---


```{r load-packages, include = FALSE}
# Add any additional packages you need to this chunk
library(tidyverse)
library(tidymodels)
library(palmerpenguins)
library(knitr)
require(GGally)
library(ggcorrplot)
library(broom)
library(readr)
library(skimr)
library(tidytext)
library(corrr)
theme_set(theme_minimal())
```

```{r setup, include=FALSE}
# For better figure resolution
knitr::opts_chunk$set(fig.retina = 3, dpi = 300, fig.width = 6, fig.asp = 0.618, out.width = "80%")
```

```{r load-data, include=FALSE}
airline <- read_csv("/cloud/project/data/airline.csv")
airport <- read_csv("/cloud/project/data/airport.csv")
lounge <- read_csv("/cloud/project/data/lounge.csv")
seat <- read_csv("/cloud/project/data/seat.csv")

```


class: center, middle

## A statement of the overall goal / research question

---

class: inverse, center, middle

## Dataset for our project

---

# Our Dataset: Skytrax User Reviews!

.pull-left[
3 datasets (Airline ratings, Seat ratings and Lounge ratings) from a Skytrax User Reviews Dataset (published August 2nd, 2015).
- Compiled as a Github Repository by quankiquanki

Each dataset has 20 variables, and the number of observations vary depending on the dataset.

- Columns: Airline Information, Author Information, Overall Rating, Contributors to the overall rating

- Observations : each observation is a passenger that filled out a survey based on their experience of the airline, lounge or seat. 
]

.pull-right[
```{r skytrax, echo = FALSE, out.width = "60%", fig.align = "center", fig.cap = "Image credit: Photo by Hak-Seon Kim on ResearchGate. Example of a Seat Review."}
include_graphics("https://www.researchgate.net/profile/Hak_Seon_Kim/publication/336240340/figure/fig1/AS:809950729232385@1570118710905/Airline-passengers-review-on-Skytrax.png")
```
]
---

class: inverse, center, middle

## Question 1
# How does the overall ratings for airlines change depending of the time of year?

---

# Assumptions

```{r mean-ratings-airlines, message = FALSE, echo = FALSE}
airline_nonas <- airline %>%
  drop_na(overall_rating) #removing any NAs
```

1. Time only ranges from 2014 to 2015 due to lack of data points for other years (n > 1500 observations)

2. Overall ratings averaged by date and airline name to avoid multiple data points for the same day

3. Focus was put on the top five airlines that had the highest overall ratings

```{r five-highest-rated-airlines, message = FALSE, echo = FALSE}
airline_nonas %>%
  group_by(airline_name) %>%
  summarise(mean_overall_rating = mean(overall_rating, na.rm = TRUE),
            n = n()) %>%
  filter(n >= 100) %>%
  arrange(desc(mean_overall_rating)) %>%
  head()
```

- These turned out to be Asiana Airlines, Garuda Indonesia, Air Astana, Bangkok Airways, and Indigo Airlines. 

---

# Overall Rating versus Time

```{r five-highest-ratings-plot, message = FALSE, echo = FALSE, eval=FALSE}
airline_nonas %>%
  group_by(airline_name, date) %>%
  summarise(mean_overall_rating = mean(overall_rating, na.rm = TRUE)) %>%
  filter(airline_name %in% c("asiana-airlines", "garuda-indonesia", "air-astana", "bangkok-airways", "indigo-airlines"),
         date >= "2014-01-01") %>%
  ggplot(aes(x = date, y = mean_overall_rating, color = airline_name)) +
  geom_smooth(se = FALSE) +
  labs(
    title = "Overall ratings of five highest ranked airlines",
    subtitle = "From 2014 to 2015",
    x = "Date",
    y = "Overall Rating"
  ) +
  guides(color = guide_legend(title = "Airline Name")) +
  theme_minimal()
  
```

---
# Overall Rating versus Time Explained 

.pull-left[
General Trends: 

- Passengers that fill out the survey tend to give high overall ratings
- There is no significant pattern in the overall ratings when comparing different years


Trends in Specific Airlines at the start of 2015: 

- Air Astana -> higher ratings in comparison to 2014
- Garuda Indonesia -> similar ratings in comparison to the last year
- Asiana Airlines, Bangkok Airways, and Indigo Airlines -> lower ratings in comparison to 2014.
]

.pull-right[

pen
]

---

# Hello World

- Click the `Knit` button to compile your presentation

- Make sure to commit and push all resulting files to your GitHub repo

---

class: inverse, middle, center

# Using xaringan

---

# xaringan

- The presentation is created using the `xaringan` package

- Use `---` to separate slides and `--` for incremental builds

--

- Like this

---

# Layouts

You can use plain text

- or bullet points

.pull-left[
or text in two columns $^*$
]
.pull-right[
- like
- this
]

.footnote[
[*] And add footnotes
]

---

# Code

```{r boring-regression}
# a boring regression
model <- lm(dist ~ speed, data = cars)
tidy(model)
glance(model)
```

---

# Plots

```{r recode-species, echo = FALSE}
# In this chunk I'm doing a bunch of analysis that I don't want to present 
# in my slides. But I need the resulting data frame for a plot I want to present.
iris_modified <- iris %>%
  mutate(Species = fct_other(Species, keep = "setosa"))
```

```{r plot-iris, echo = FALSE}
# Code hidden with echo = FALSE
# Uses modified iris dataset from previous chunk
# Play around with height and width until you're happy with the look
ggplot(data = iris_modified, mapping = aes(x = Sepal.Width, y = Sepal.Length, color = Species)) +
  geom_point() + 
  theme_minimal() # theme options: https://ggplot2.tidyverse.org/reference/ggtheme.html
```

---

## Plot and text

.pull-left[
- Some text
- goes here
]
.pull-right[
```{r warning=FALSE, out.width="100%", fig.width=4, echo=FALSE}
# see how I changed out.width and fig.width from defaults
# to make the figure bigger
ggplot(penguins, aes(x = bill_length_mm, y = species, color = species)) +
  geom_boxplot() +
  theme_minimal()
```
]

---

# Tables

If you want to generate a table, make sure it is in the HTML format (instead of Markdown or other formats), e.g.,



---

# Images

```{r castle, echo = FALSE, out.width = "60%", fig.align = "center", fig.cap = "Image credit: Photo by JÃ¶rg Angeli on Unsplash."}
include_graphics("https://images.unsplash.com/photo-1535448033526-c0e85c9e6968?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1650&q=80")
```

Or you can also include a full page image. See next slide.

---

background-image: url(https://images.unsplash.com/photo-1535448033526-c0e85c9e6968?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1650&q=80)

---

# Math Expressions

You can write LaTeX math expressions inside a pair of dollar signs, e.g. &#36;\alpha+\beta$ renders $\alpha+\beta$. You can use the display style with double dollar signs:

```
$$\bar{X}=\frac{1}{n}\sum_{i=1}^nX_i$$
```

$$\bar{X}=\frac{1}{n}\sum_{i=1}^nX_i$$

Limitations:

1. The source code of a LaTeX math expression must be in one line, unless it is inside a pair of double dollar signs, in which case the starting `$$` must appear in the very beginning of a line, followed immediately by a non-space character, and the ending `$$` must be at the end of a line, led by a non-space character;

1. There should not be spaces after the opening `$` or before the closing `$`.

1. Math does not work on the title slide (see [#61](https://github.com/yihui/xaringan/issues/61) for a workaround).

---

# Feeling adventurous?

- Want to find out more about `xaringan`? See https://slides.yihui.name/xaringan/#1.

- You are welcomed to use the default styling of the slides. In fact, that's what I expect majority of you will do. You will differentiate yourself with the content of your presentation.

- But some of you might want to play around with slide styling. The 
`xaringanthemer` provides some solutions for this that: https://pkg.garrickadenbuie.com/xaringanthemer.

- And if you want more bells and whistles, there is also `xaringanExtra`: https://pkg.garrickadenbuie.com/xaringanExtra.

---
# Question 1

Question: How does the overall ratings for airlines change depending of the time of year? Do these patterns repeat every year? Which traveller type is present during which time of the year?

---
# Question 2

To what extent do passengers in first class give better ratings
than passengers in other cabin types? 
Note: There are 4 different cabins in this dataset ( First class, Business Class, Premium Economy, Economy)

Let's look at the average overall rating the passengers gave for each of the classes. 
Hypothesis: We expect first class to have a higher rating since, as per the norm, first class is considered to be the most preferable one.

```{r, echo = FALSE, message = FALSE, eval = FALSE}
airline %>%
  filter(!is.na(overall_rating), !is.na(cabin_flown) ) %>%
  group_by(cabin_flown) %>%
  summarise(mean_overall_rating = mean(overall_rating, na.rm = TRUE)) %>%
  arrange(desc(mean_overall_rating))
```

Business class has received the highest amount of rating. It is closely followed by 
First class. This doesn't match our hypothesis. 

Is this because passengers feel the business class services are better or fewer people choose
to travel in first class?
Let's find out!

---



```{r echo = FALSE, message = FALSE, eval = FALSE}
airline %>%
  filter(!is.na(overall_rating), !is.na(cabin_flown) ) %>%
  group_by(cabin_flown) %>%
  count(cabin_flown) %>%
  arrange(desc(n))
```

Now, it is obvious that first class has a lower rating compared to business 
class since fewer passengers chose that cabin type. 


---

# Do airline improve their rating with a particular customer over time
First we need to filter out all the reviewers who didn't rate a airline twice
```{r filter-repeated-authors}
author_more_than_once <-airline%>%
  mutate(duplicate_auth = duplicated(.$author))%>%
  filter(duplicate_auth)%>%
  group_by(airline_name,author)%>%
  mutate(count = n())%>%
  filter(count>1)%>%
  ungroup()
```
after filtering out the reviewers who didn't rate a single airline more than once we are left with `r nrow(author_more_than_once)` and `r length(unique(author_more_than_once$author))` unique authors
---
```{r repeated-rating-distribution, echo=FALSE,  message=FALSE}  
author_more_than_once%>%
  group_by(author)%>%
  summarize(count = n())%>%
  ggplot(aes(x=count))+
  geom_histogram()+
  labs(
    title = "Repeated rating of one airline",
    subtitle = "by one customer",
    x = "times rated",
    y = "number of reviewers"
  )
  
```
- significantly right skewed
- most rate only twice
- hardly any people rate one airline more than 10 times
---
# Definition of improvement
- slope of linear fit
- 3 levels 
  - -1 - got worse
  - 0 - no improvement
  - 1 - improvement
  
.pull-left[
```{r postive-slope, echo=FALSE, message=FALSE}
airline%>%
  filter(author == "A Krummacher",
         airline_name == "srilankan-airlines")%>%
  ggplot(aes(x=date, y=overall_rating))+
  geom_point()+
  geom_smooth(method = "lm", se = FALSE)+
  labs(
    title = "Rating of srilanka airlines over time",
    subtitle = "by one reviewer",
    x = "Date",
    y = "Overal rating"
  )


```
]
.pull-right[
```{r negative-slope, echo=FALSE, message=FALSE}
airline%>%
  filter(author == "A Clarke",
         airline_name == "ryanair")%>%
  ggplot(aes(x=date, y=overall_rating))+
  geom_point()+
  geom_smooth(method = "lm", se = FALSE)+
  labs(
    title = "Rating of united airlines over time",
    subtitle = "by one reviewer",
    x = "Date",
    y = "Overal rating"
  )
```
]
---





```{r slopes-function, echo=FALSE}
#https://stackoverflow.com/a/31874484
slopes <- function(response) {
  return(
    author_more_than_once %>% 
  select(airline_name, author, y = response,X = date)%>%
  group_by(author,airline_name) %>%
  filter(!is.na(X),!is.na(y))%>%
  do(data.frame(model = tidy(lm(y~X, data=.)))) %>%
  ungroup
  )
}
```

```{r map-slope-responses, eval=FALSE}
responses = c("overall_rating",
              "seat_comfort_rating",
              "cabin_staff_rating",
              "food_beverages_rating",
              "inflight_entertainment_rating",
              "wifi_connectivity_rating",
              "value_money_rating")

list_slopes <- map(responses,slopes)
```
```{r eval=FALSE}
data.frame(list_slopes[1])%>%
  filter(model.estimate<0)
  
```



---
```{r eval=FALSE}
transform <- function(df, response){
    working_df <- df%>%
    filter(model.term == "X")%>%
    select(author,airline_name, slope = model.estimate)%>%
    mutate(improvement = sign(slope))%>%
    group_by(airline_name)%>%
      mutate(mean_improvement = mean(improvement))%>%
    ungroup
    names(working_df)[3] <- paste(response,"slope",sep = "_")
    names(working_df)[4] <- paste(response,"improvement",sep = "_")
    return(working_df)
}
```


```{r eval=FALSE}
list_slopes_trans <- map2(list_slopes,responses,transform)

joint_improvements <- list_slopes_trans %>% reduce(left_join, by = c("author","airline_name"))
joint_improvements
```
---
```{r eval=FALSE}
joint_improvements%>%
  select(overall_rating_improvement,
         cabin_staff_rating_improvement,
         food_beverages_rating_improvement,
         seat_comfort_rating_improvement,
         inflight_entertainment_rating_improvement,
         wifi_connectivity_rating_improvement,
         value_money_rating_improvement)%>%
  correlate()
  
```

```{r eval=FALSE}
joint_improvements%>%
ggplot(aes(y = overall_rating_improvement, x = value_money_rating_improvement))+
  geom_jitter()

map(responses, cors)
```

We can see that most airlines don't improve from flight to flight but with the improvement mean being 





---
# Question 4

